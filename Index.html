<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA & Mobile enhancements -->
    <meta name="theme-color" content="#2563eb"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Astrup">

    <title>Astrup (V√©rg√°z) √ârt√©kel≈ë</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .input-field {
            transition: all 0.3s ease;
        }
        .input-field:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="py-10 px-4">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-slate-800 mb-2">ü©∏ Astrup √ârt√©kel≈ë</h1>
            <p class="text-slate-600">V√©rg√°zparam√©terek elemz√©se √©s sav-b√°zis egyens√∫ly diagnosztika</p>
        </div>

        <div class="grid lg:grid-cols-12 gap-6">
            <!-- Input Section -->
            <div class="lg:col-span-4 glass-panel rounded-2xl shadow-xl p-8 h-fit">
                <h2 class="text-2xl font-semibold text-slate-700 mb-6 flex items-center">
                    <i class="fas fa-vial text-blue-500 mr-3"></i> M√©rt √©rt√©kek
                </h2>
                
                <form id="astrupForm" class="space-y-6" onsubmit="handleCalculation(event)">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">pH √©rt√©k</label>
                        <div class="relative">
                            <input type="number" id="ph" step="0.01" placeholder="7.40" oninput="handleCalculation()"
                                class="input-field w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none text-slate-700 font-medium" required>
                            <span class="absolute right-4 top-3.5 text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">Ref: 7.35 - 7.45</span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">PaCO‚ÇÇ (mmHg)</label>
                        <div class="relative">
                            <input type="number" id="pco2" step="0.1" placeholder="40.0" oninput="handleCalculation()"
                                class="input-field w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none text-slate-700 font-medium" required>
                            <span class="absolute right-4 top-3.5 text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">Ref: 35 - 45</span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">HCO‚ÇÉ‚Åª (mEq/L)</label>
                        <div class="relative">
                            <input type="number" id="hco3" step="0.1" placeholder="24.0" oninput="handleCalculation()"
                                class="input-field w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none text-slate-700 font-medium" required>
                            <span class="absolute right-4 top-3.5 text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">Ref: 22 - 26</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-2">PaO‚ÇÇ (mmHg)</label>
                            <div class="relative">
                                <input type="number" id="po2" step="0.1" placeholder="90.0" oninput="handleCalculation()"
                                    class="input-field w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none text-slate-700 font-medium">
                                <span class="absolute right-2 top-3.5 text-xs text-slate-400 bg-slate-100 px-1 py-1 rounded">Ref: 75-100</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-2">SaO‚ÇÇ (%)</label>
                            <div class="relative">
                                <input type="number" id="so2" step="0.1" placeholder="98.0" oninput="handleCalculation()"
                                    class="input-field w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none text-slate-700 font-medium">
                                <span class="absolute right-2 top-3.5 text-xs text-slate-400 bg-slate-100 px-1 py-1 rounded">Ref: 95-100</span>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-slate-100">
                        <h3 class="text-sm font-semibold text-slate-500 mb-4">Anion r√©s sz√°m√≠t√°s (Opcion√°lis)</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-2">Na‚Å∫ (mEq/L)</label>
                                <div class="relative">
                                    <input type="number" id="na" step="1" placeholder="140" oninput="handleCalculation()"
                                        class="input-field w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none text-slate-700 font-medium">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-2">Cl‚Åª (mEq/L)</label>
                                <div class="relative">
                                    <input type="number" id="cl" step="1" placeholder="100" oninput="handleCalculation()"
                                        class="input-field w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none text-slate-700 font-medium">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" 
                        class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg transform transition hover:-translate-y-1 hover:shadow-xl flex items-center justify-center gap-2">
                        <i class="fas fa-calculator"></i> Elemz√©s futtat√°sa
                    </button>
                </form>
            </div>

            <!-- Result Section -->
            <div id="resultPanel" class="hidden lg:col-span-8 glass-panel rounded-2xl shadow-xl p-8 relative overflow-hidden fade-in h-fit">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-blue-500" id="statusLine"></div>
                
                <h2 class="text-2xl font-semibold text-slate-700 mb-6 flex items-center">
                    <i class="fas fa-clipboard-check text-green-500 mr-3"></i> Eredm√©ny
                </h2>

                <!-- Validation Warning -->
                <div id="validationWarning" class="hidden mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded-r shadow-sm">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-red-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-700 font-bold">Adat inkonzisztencia!</p>
                            <p id="validationMessage" class="text-sm text-red-600"></p>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <!-- Main Diagnosis -->
                    <div class="bg-slate-50 rounded-xl p-6 border border-slate-100 shadow-inner">
                        <h3 class="text-xs uppercase tracking-wide text-slate-500 font-bold mb-2">Diagn√≥zis</h3>
                        <p id="diagnosisText" class="text-xl font-bold text-slate-800 leading-relaxed">
                            -
                        </p>
                    </div>

                    <!-- Details Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="flex flex-col p-4 rounded-xl bg-white border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                            <span class="text-slate-500 text-xs font-bold uppercase mb-2">pH St√°tusz</span>
                            <span id="phStatus" class="text-sm font-bold text-slate-700">-</span>
                        </div>
                        <div class="flex flex-col p-4 rounded-xl bg-white border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                            <span class="text-slate-500 text-xs font-bold uppercase mb-2">L√©gz√©s (PaCO‚ÇÇ)</span>
                            <span id="pco2Status" class="text-sm font-bold text-slate-700">-</span>
                        </div>
                        <div class="flex flex-col p-4 rounded-xl bg-white border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                            <span class="text-slate-500 text-xs font-bold uppercase mb-2">Anyagcsere (HCO‚ÇÉ‚Åª)</span>
                            <span id="hco3Status" class="text-sm font-bold text-slate-700">-</span>
                        </div>
                        <div id="anionGapRow" class="hidden flex flex-col p-4 rounded-xl bg-white border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                            <span class="text-slate-500 text-xs font-bold uppercase mb-2">Anion R√©s</span>
                            <div class="flex items-center justify-between">
                                <span id="anionGapValue" class="font-bold text-slate-800 text-lg"></span>
                                <span id="anionGapStatus" class="text-xs font-bold px-2 py-1 rounded bg-slate-100">-</span>
                            </div>
                        </div>
                        <div id="deltaGapRow" class="hidden flex flex-col p-4 rounded-xl bg-white border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                            <span class="text-slate-500 text-xs font-bold uppercase mb-2">Delta Ratio</span>
                            <div class="flex flex-col">
                                <span id="deltaRatioValue" class="font-bold text-slate-800 text-lg"></span>
                                <span id="correctedHco3Value" class="text-xs text-blue-600 font-medium mt-1"></span>
                            </div>
                        </div>
                        <div id="oxygenRow" class="hidden flex flex-col p-4 rounded-xl bg-white border border-blue-100 shadow-sm hover:shadow-md transition-shadow border-l-4 border-l-blue-400">
                            <span class="text-slate-500 text-xs font-bold uppercase mb-2">Oxigeniz√°ci√≥</span>
                            <div class="flex flex-col">
                                <span id="oxygenStatus" class="font-bold text-slate-800 text-sm mb-1"></span>
                                <span id="oxygenNeeded" class="text-xs font-bold text-red-600"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Section -->
                    <div class="mt-6 p-4 bg-white rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="text-sm font-bold text-slate-500 uppercase mb-4">Sav-B√°zis T√©rk√©p (pH vs HCO‚ÇÉ‚Åª)</h4>
                        <div class="relative h-64 w-full">
                            <canvas id="astrupChart"></canvas>
                        </div>
                    </div>

                    <!-- Visual Aid / Interpretation -->
                    <div class="mt-4 pt-4 border-t border-slate-200">
                        <h4 class="text-sm font-semibold text-slate-500 mb-2">Megjegyz√©s</h4>
                        <div class="text-xs text-slate-500 space-y-1 bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <p><i class="fas fa-info-circle mr-1 text-blue-400"></i> <strong>ROME szab√°ly:</strong> Respiratory Opposite, Metabolic Equal</p>
                            <p><i class="fas fa-flask mr-1 text-blue-400"></i> <strong>Anion r√©s:</strong> Norm√°l tartom√°ny: 8 - 12 mEq/L (Na - [Cl + HCO‚ÇÉ])</p>
                            <p><i class="fas fa-calculator mr-1 text-blue-400"></i> <strong>Delta Gap:</strong> Seg√≠t a kevert metabolikus zavarok azonos√≠t√°s√°ban magas anion r√©s eset√©n.</p>
                            <p><i class="fas fa-lungs mr-1 text-blue-400"></i> <strong>Hipox√©mia:</strong> PaO‚ÇÇ < 60 mmHg s√∫lyos √°llapotot jelezhet.</p>
                            <p class="mt-1">Ez az eszk√∂z oktat√°si c√©lokat szolg√°l √©s nem helyettes√≠ti a szakorvosi diagn√≥zist.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detailed Analysis Section (Moved out of main grid) -->
        <div class="grid md:grid-cols-2 gap-6 mt-6">
            <!-- Clinical Explanations -->
            <div id="clinicalExplanation" class="hidden glass-panel rounded-2xl shadow-xl p-8 fade-in h-fit">
                <h4 class="text-xl font-semibold text-slate-700 mb-4 flex items-center"><i class="fas fa-user-md text-blue-500 mr-3"></i>Lehets√©ges klinikai okok</h4>
                <div id="explanationContent" class="text-sm text-slate-600 space-y-4"></div>
            </div>

            <!-- Therapeutic Recommendations -->
            <div id="therapeuticRecommendation" class="hidden glass-panel rounded-2xl shadow-xl p-8 fade-in h-fit">
                <h4 class="text-xl font-semibold text-slate-700 mb-4 flex items-center"><i class="fas fa-user-nurse text-green-500 mr-3"></i>Ter√°pi√°s javaslatok</h4>
                <div id="recommendationContent" class="text-sm text-slate-600 space-y-4"></div>
            </div>
        </div>

        <!-- Knowledge Base Section -->
        <div class="mt-10 glass-panel rounded-2xl shadow-xl p-8">
            <h2 class="text-2xl font-semibold text-slate-700 mb-6 flex items-center">
                <i class="fas fa-book-medical text-purple-500 mr-3"></i> Tud√°st√°r: √ârt√©kek √©s Okok
            </h2>
            
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Reference Values -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-600 mb-3">Referencia tartom√°nyok</h3>
                    <div class="overflow-hidden rounded-lg border border-slate-200">
                        <table class="min-w-full bg-white text-sm">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="py-2 px-4 text-left text-slate-600">Param√©ter</th>
                                    <th class="py-2 px-4 text-left text-slate-600">Norm√°l √©rt√©k</th>
                                    <th class="py-2 px-4 text-left text-slate-600">Jelent√©s</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr>
                                    <td class="py-2 px-4 font-medium">pH</td>
                                    <td class="py-2 px-4">7.35 - 7.45</td>
                                    <td class="py-2 px-4 text-slate-500">V√©r k√©mhat√°sa</td>
                                </tr>
                                <tr>
                                    <td class="py-2 px-4 font-medium">PaCO‚ÇÇ</td>
                                    <td class="py-2 px-4">35 - 45 mmHg</td>
                                    <td class="py-2 px-4 text-slate-500">L√©gz√©si komponens (Sav)</td>
                                </tr>
                                <tr>
                                    <td class="py-2 px-4 font-medium">HCO‚ÇÉ‚Åª</td>
                                    <td class="py-2 px-4">22 - 26 mEq/L</td>
                                    <td class="py-2 px-4 text-slate-500">Anyagcsere komponens (B√°zis)</td>
                                </tr>
                                <tr>
                                    <td class="py-2 px-4 font-medium">Anion r√©s</td>
                                    <td class="py-2 px-4">8 - 12 mEq/L</td>
                                    <td class="py-2 px-4 text-slate-500">Metabolikus acid√≥zis oka</td>
                                </tr>
                                <tr>
                                    <td class="py-2 px-4 font-medium">Delta Ratio</td>
                                    <td class="py-2 px-4">1 - 2</td>
                                    <td class="py-2 px-4 text-slate-500">Kevert zavarok sz≈±r√©se</td>
                                </tr>
                                <tr>
                                    <td class="py-2 px-4 font-medium">PaO‚ÇÇ</td>
                                    <td class="py-2 px-4">75 - 100 mmHg</td>
                                    <td class="py-2 px-4 text-slate-500">Art√©ri√°s oxig√©n nyom√°s</td>
                                </tr>
                                <tr>
                                    <td class="py-2 px-4 font-medium">SaO‚ÇÇ</td>
                                    <td class="py-2 px-4">95 - 100 %</td>
                                    <td class="py-2 px-4 text-slate-500">Oxig√©n szatur√°ci√≥</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Interpretation Guide -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-600 mb-3">Zavarok √©s Okok</h3>
                    <div class="space-y-3">
                        <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                            <strong class="text-red-700 block mb-1">Metabolikus Acid√≥zis (‚ÜìpH, ‚ÜìHCO‚ÇÉ‚Åª)</strong>
                            <p class="text-xs text-slate-600">Okok: Ketoacid√≥zis (DKA), Veseel√©gtelens√©g, Tejsav acid√≥zis, Hasmen√©s, M√©rgez√©sek (MUDPILES).</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <strong class="text-blue-700 block mb-1">Metabolikus Alkal√≥zis (‚ÜëpH, ‚ÜëHCO‚ÇÉ‚Åª)</strong>
                            <p class="text-xs text-slate-600">Okok: H√°ny√°s, Gyomorszonda, Diuretikumok, Hipokal√©mia.</p>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                            <strong class="text-red-700 block mb-1">Respirat√≥rikus Acid√≥zis (‚ÜìpH, ‚ÜëPaCO‚ÇÇ)</strong>
                            <p class="text-xs text-slate-600">Okok: Hipoventill√°ci√≥, COPD, Asztma, L√©g√∫ti elz√°r√≥d√°s, Opioid t√∫ladagol√°s.</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <strong class="text-blue-700 block mb-1">Respirat√≥rikus Alkal√≥zis (‚ÜëpH, ‚ÜìPaCO‚ÇÇ)</strong>
                            <p class="text-xs text-slate-600">Okok: Hiperventill√°ci√≥, Szorong√°s, F√°jdalom, L√°z, T√ºd≈ëemb√≥lia.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-12 text-slate-500 text-sm">
            <p>¬© 2026 Dr. Nyul Zolt√°n √©s Dr. P√©terfi Zolt√°n - Astrup √ârt√©kel≈ë Program</p>
            <p>verzi√≥ 1.2.0</p>
        </footer>
    </div>

    <script>
        // Konstansok
        const PH_MIN = 7.35;
        const PH_MAX = 7.45;
        const PCO2_MIN = 35.0;
        const PCO2_MAX = 45.0;
        const HCO3_MIN = 22.0;
        const HCO3_MAX = 26.0;

        let myChart = null;

        function handleCalculation(event) {
            if (event) event.preventDefault();
            
            const phInput = document.getElementById('ph').value;
            const pco2Input = document.getElementById('pco2').value;
            const hco3Input = document.getElementById('hco3').value;

            if (!phInput || !pco2Input || !hco3Input) {
                document.getElementById('resultPanel').classList.add('hidden');
                return;
            }

            const ph = parseFloat(phInput);
            const pco2 = parseFloat(pco2Input);
            const hco3 = parseFloat(hco3Input);
            
            // Oxigeniz√°ci√≥
            const po2 = document.getElementById('po2').value ? parseFloat(document.getElementById('po2').value) : null;
            const so2 = document.getElementById('so2').value ? parseFloat(document.getElementById('so2').value) : null;
            
            // Opcion√°lis elektrolitok
            const na = document.getElementById('na').value ? parseFloat(document.getElementById('na').value) : null;
            const cl = document.getElementById('cl').value ? parseFloat(document.getElementById('cl').value) : null;

            const result = evaluateAstrup(ph, pco2, hco3);
            
            // Anion r√©s sz√°m√≠t√°s
            const anionGap = (na !== null && cl !== null) ? (na - (cl + hco3)) : null;

            // Delta Gap sz√°m√≠t√°s (csak ha AG magas > 12)
            let deltaData = null;
            if (anionGap !== null && anionGap > 12) {
                 const deltaAG = anionGap - 12;
                 const correctedHCO3 = hco3 + deltaAG;
                 // Delta Ratio: Delta AG / Delta HCO3 (24 - measured HCO3)
                 const deltaRatio = (hco3 < 24) ? (deltaAG / (24 - hco3)) : null;
                 deltaData = { deltaRatio, correctedHCO3 };
            }
            
            // Oxigeniz√°ci√≥ √©rt√©kel√©se
            const oxygenData = evaluateOxygenation(po2, so2);
            
            // Adatvalid√°ci√≥
            const validation = validateConsistency(ph, pco2, hco3);
            const warningEl = document.getElementById('validationWarning');
            if (!validation.isValid) {
                warningEl.classList.remove('hidden');
                document.getElementById('validationMessage').textContent = validation.message;
            } else {
                warningEl.classList.add('hidden');
            }

            displayResult(result, anionGap, deltaData, oxygenData);
            updateChart(ph, hco3);
        }

        function evaluateAstrup(ph, pco2, hco3) {
            // 1. pH elemz√©se
            let phStatus = "Norm√°l pH";
            if (ph < PH_MIN) phStatus = "Acid√≥zis";
            else if (ph > PH_MAX) phStatus = "Alkal√≥zis";

            // 2. PaCO2 elemz√©se (Respirat√≥rikus)
            let pco2Status = "Norm√°l";
            if (pco2 < PCO2_MIN) pco2Status = "Alkal√≥zis"; // Alacsony CO2 l√∫gos√≠t
            else if (pco2 > PCO2_MAX) pco2Status = "Acid√≥zis"; // Magas CO2 savas√≠t

            // 3. HCO3 elemz√©se (Metabolikus)
            let hco3Status = "Norm√°l";
            if (hco3 < HCO3_MIN) hco3Status = "Acid√≥zis"; // Alacsony HCO3 savas√≠t
            else if (hco3 > HCO3_MAX) hco3Status = "Alkal√≥zis"; // Magas HCO3 l√∫gos√≠t

            // 4. Diagn√≥zis
            let diagnosis = "";
            let colorClass = "bg-green-100 text-green-800"; // Default normal color

            if (phStatus === "Norm√°l pH") {
                if (pco2Status === "Norm√°l" && hco3Status === "Norm√°l") {
                    diagnosis = "Teljesen norm√°l v√©rg√°z √©rt√©kek.";
                } else if (pco2Status !== "Norm√°l" && hco3Status !== "Norm√°l") {
                    if (ph < 7.40) diagnosis = "Teljesen kompenz√°lt Acid√≥zis (vagy kevert zavar)";
                    else diagnosis = "Teljesen kompenz√°lt Alkal√≥zis (vagy kevert zavar)";
                    colorClass = "bg-yellow-100 text-yellow-800";
                } else {
                    diagnosis = "Norm√°l pH, de izol√°lt elt√©r√©s √©szlelhet≈ë.";
                    colorClass = "bg-yellow-100 text-yellow-800";
                }
            } else {
                let primaryCauses = [];
                let compensation = false;

                if (pco2Status === phStatus) {
                    primaryCauses.push("Respirat√≥rikus");
                    if (hco3Status !== "Norm√°l" && hco3Status !== phStatus) compensation = true;
                }

                if (hco3Status === phStatus) {
                    primaryCauses.push("Metabolikus");
                    if (pco2Status !== "Norm√°l" && pco2Status !== phStatus) compensation = true;
                }

                if (primaryCauses.length === 0) {
                    diagnosis = "Kevert vagy komplex zavar (az √©rt√©kek ellentmond√°sosak).";
                    colorClass = "bg-red-100 text-red-800";
                } else {
                    let type = primaryCauses.join(" √©s ");
                    let compText = compensation ? "R√©szlegesen kompenz√°lt" : "Dekompenz√°lt";
                    diagnosis = `${compText} ${type} ${phStatus}`;
                    colorClass = phStatus === "Acid√≥zis" ? "bg-red-100 text-red-800" : "bg-blue-100 text-blue-800";
                }
            }

            return { phStatus, pco2Status, hco3Status, diagnosis, colorClass };
        }

        function evaluateOxygenation(po2, so2) {
            if (po2 === null && so2 === null) return null;

            let status = "Norm√°l oxigeniz√°ci√≥";
            let needed = "Nincs sz√ºks√©g oxig√©nre";
            let color = "bg-green-100 text-green-800";

            if (po2 !== null) {
                if (po2 < 40) { status = "S√∫lyos hipox√©mia"; needed = "IGEN (Kritikus)"; color = "bg-red-100 text-red-800"; }
                else if (po2 < 60) { status = "M√©rs√©kelt hipox√©mia"; needed = "IGEN (S√ºrg≈ës)"; color = "bg-orange-100 text-orange-800"; }
                else if (po2 < 75) { status = "Enyhe hipox√©mia"; needed = "Megfontoland√≥"; color = "bg-yellow-100 text-yellow-800"; }
            } else if (so2 !== null) {
                if (so2 < 90) { status = "Kritikus deszatur√°ci√≥"; needed = "IGEN"; color = "bg-red-100 text-red-800"; }
                else if (so2 < 95) { status = "Cs√∂kkent szatur√°ci√≥"; needed = "Megfontoland√≥"; color = "bg-yellow-100 text-yellow-800"; }
            }

            return { status, needed, color };
        }

        function validateConsistency(ph, pco2, hco3) {
            // Henderson-Hasselbalch egyenlet ellen≈ërz√©s
            // pH = 6.1 + log(HCO3 / (0.03 * PaCO2))
            const expectedPh = 6.1 + Math.log10(hco3 / (0.03 * pco2));
            const diff = Math.abs(ph - expectedPh);
            
            // 0.06 t≈±r√©shat√°r (klinikai gyakorlatban elfogadhat√≥ m√©r√©si/sz√°m√≠t√°si elt√©r√©s)
            if (diff > 0.06) {
                return {
                    isValid: false,
                    message: `A megadott pH (${ph}) nem egyezik a PaCO‚ÇÇ √©s HCO‚ÇÉ‚Åª alapj√°n sz√°m√≠tott √©rt√©kkel (${expectedPh.toFixed(2)}). K√©rlek ellen≈ërizd az adatokat!`
                };
            }
            return { isValid: true };
        }

        function displayResult(data, anionGap, deltaData, oxygenData) {
            const panel = document.getElementById('resultPanel');
            panel.classList.remove('hidden');
            
            document.getElementById('diagnosisText').textContent = data.diagnosis;
            document.getElementById('diagnosisText').className = `text-xl font-bold leading-relaxed px-2 py-1 rounded ${data.colorClass}`;
            
            updateStatusBadge('phStatus', data.phStatus);
            updateStatusBadge('pco2Status', data.pco2Status);
            updateStatusBadge('hco3Status', data.hco3Status);
            
            // Anion r√©s megjelen√≠t√©se
            const agRow = document.getElementById('anionGapRow');
            if (anionGap !== null) {
                agRow.classList.remove('hidden');
                document.getElementById('anionGapValue').textContent = anionGap.toFixed(1) + " mEq/L";
                
                let agStatus = "Norm√°l";
                let agColor = "bg-green-100 text-green-600";
                
                if (anionGap > 12) { agStatus = "Magas"; agColor = "bg-red-100 text-red-600"; }
                else if (anionGap < 8) { agStatus = "Alacsony"; agColor = "bg-blue-100 text-blue-600"; }
                
                const statusEl = document.getElementById('anionGapStatus');
                statusEl.textContent = agStatus;
                statusEl.className = `text-xs font-bold px-2 py-1 rounded ${agColor}`;
            } else {
                agRow.classList.add('hidden');
            }
            
            // Delta Gap megjelen√≠t√©se
            const deltaRow = document.getElementById('deltaGapRow');
            if (deltaData !== null) {
                deltaRow.classList.remove('hidden');
                let ratioText = deltaData.deltaRatio !== null ? deltaData.deltaRatio.toFixed(2) : "> 2.0";
                document.getElementById('deltaRatioValue').textContent = ratioText;
                document.getElementById('correctedHco3Value').textContent = "Korr. HCO‚ÇÉ‚Åª: " + deltaData.correctedHCO3.toFixed(1) + " mEq/L";
            } else {
                deltaRow.classList.add('hidden');
            }
            
            // Oxigeniz√°ci√≥ megjelen√≠t√©se
            const oxyRow = document.getElementById('oxygenRow');
            if (oxygenData !== null) {
                oxyRow.classList.remove('hidden');
                const statusEl = document.getElementById('oxygenStatus');
                statusEl.textContent = oxygenData.status;
                statusEl.className = `font-bold text-sm mb-1 ${oxygenData.color.replace('bg-', 'text-').replace('100', '600')}`;
                document.getElementById('oxygenNeeded').textContent = "Oxig√©nig√©ny: " + oxygenData.needed;
            } else {
                oxyRow.classList.add('hidden');
            }

            // Klinikai okok megjelen√≠t√©se
            const causes = getClinicalCauses(data.phStatus, data.pco2Status, data.hco3Status, anionGap, deltaData);
            const explanationPanel = document.getElementById('clinicalExplanation');
            const explanationContent = document.getElementById('explanationContent');
            
            if (causes.length > 0) {
                explanationPanel.classList.remove('hidden');
                explanationContent.innerHTML = causes.join('<div class="border-t border-slate-100 my-3"></div>');
            } else {
                explanationPanel.classList.add('hidden');
            }

            // Ter√°pi√°s javaslatok megjelen√≠t√©se
            const recommendations = getTherapeuticRecommendations(data.phStatus, data.pco2Status, data.hco3Status, oxygenData);
            const recommendationPanel = document.getElementById('therapeuticRecommendation');
            const recommendationContent = document.getElementById('recommendationContent');
            
            if (recommendations.length > 0) {
                recommendationPanel.classList.remove('hidden');
                recommendationContent.innerHTML = recommendations.join('<div class="border-t border-slate-100 my-3"></div>');
            } else {
                recommendationPanel.classList.add('hidden');
            }
        }

        function updateStatusBadge(id, status) {
            const el = document.getElementById(id);
            el.textContent = status;
            
            let color = "bg-slate-100 text-slate-600";
            if (status === "Acid√≥zis") color = "bg-red-100 text-red-600";
            else if (status === "Alkal√≥zis") color = "bg-blue-100 text-blue-600";
            else if (status === "Norm√°l" || status === "Norm√°l pH") color = "bg-green-100 text-green-600";
            
            el.className = `text-sm font-bold ${color.replace('bg-', 'text-').replace('100', '600')}`;
        }

        function getClinicalCauses(phStatus, pco2Status, hco3Status, anionGap, deltaData) {
            let causes = [];

            // Metabolikus Acid√≥zis
            if (hco3Status === "Acid√≥zis") {
                if (anionGap !== null && anionGap > 12) {
                    causes.push(`<div><strong>Metabolikus Acid√≥zis (Sz√©les Anion R√©s):</strong>
                        <ul class="list-disc list-inside mt-1 ml-2 space-y-2 text-sm">
                            <li><strong>Ketoacid√≥zis:</strong>
                                <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                    <li>√âhez√©s</li>
                                    <li>Diabetes</li>
                                </ul>
                            </li>
                            <li><strong>Lakt√°tacid√≥zis:</strong>
                                <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                    <li>Sz√∂veti hypoperfusio (A t√≠pus)</li>
                                    <li>CH metabolizmus zavar (B t√≠pus)</li>
                                </ul>
                            </li>
                            <li><strong>Veseel√©gtelens√©g:</strong>
                                <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                    <li>Akut veseel√©gtelens√©g</li>
                                    <li>Uraemia</li>
                                </ul>
                            </li>
                            <li><strong>Toxikus okok:</strong>
                                <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                    <li>Etil√©nglikol, metanol intox.*</li>
                                    <li>Salicylat intox.**</li>
                                </ul>
                            </li>
                        </ul></div>`);
                } else if (anionGap !== null && anionGap <= 12) {
                     causes.push(`<div><strong>Metabolikus Acid√≥zis (Norm√°l Anion R√©s - Hiperklor√©mi√°s):</strong>
                        <ul class="list-disc list-inside mt-1 ml-2 space-y-2 text-sm">
                            <li><strong>Vese eredet≈±:</strong>
                                <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                    <li>Ren√°lis tubul√°ris acid√≥zis (3 t√≠pus)</li>
                                    <li>Carboanhidr√°z g√°tl√≥</li>
                                </ul>
                            </li>
                            <li><strong>GIT (Gasztrointesztin√°lis):</strong>
                                <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                    <li>Hasmen√©s</li>
                                    <li>V√©konyb√©lfistula</li>
                                    <li>Ureteroenterostoma</li>
                                </ul>
                            </li>
                            <li><strong>Egy√©b:</strong>
                                <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                    <li>Ketoacid√≥zis rendez≈ëd√©se</li>
                                    <li>Kr√≥nikus resp. alkal√≥zis rendez≈ëd√©se</li>
                                </ul>
                            </li>
                        </ul></div>`);
                } else {
                    // Ha nincs anion r√©s megadva
                    causes.push(`<div><strong>Metabolikus Acid√≥zis:</strong>
                        <ul class="list-disc list-inside mt-1 ml-2 space-y-1 text-sm">
                            <li><strong>Ketoacid√≥zis:</strong> Cukorbetegs√©g (DKA), Alkoholizmus, √âhez√©s.</li>
                            <li><strong>Tejsav acid√≥zis:</strong> Sz√∂veti hipoxia (Sokk, Szepszis), M√°jel√©gtelens√©g.</li>
                            <li><strong>Veseel√©gtelens√©g:</strong> Savak kiv√°laszt√°s√°nak cs√∂kken√©se.</li>
                            <li><strong>Bikarbon√°t veszt√©s:</strong> S√∫lyos hasmen√©s.</li>
                            <li><strong>M√©rgez√©sek:</strong> Szalicil√°t, Metanol, Etil√©n-glikol.</li>
                        </ul>
                        <p class="mt-2 text-xs text-blue-500 font-medium"><i class="fas fa-lightbulb mr-1"></i> Tipp: Add meg a Na‚Å∫ √©s Cl‚Åª √©rt√©keket az Anion R√©s sz√°m√≠t√°s√°hoz a pontosabb okok√©rt (MUDPILES)!</p></div>`);
                }
            }

            // Metabolikus Alkal√≥zis
            if (hco3Status === "Alkal√≥zis") {
                causes.push(`<div><strong>Metabolikus Alkal√≥zis:</strong>
                    <ul class="list-disc list-inside mt-1 ml-2 space-y-2 text-sm">
                        <li><strong>Kloridszenzit√≠v (Volumen depl√©ci√≥) [Vizelet Cl‚Åª < 10 mmol/l]:</strong>
                            <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                <li><strong>Vese-eredet≈±:</strong>
                                    <ul class="list-disc list-inside ml-4">
                                        <li>Diureticumok (furosemid, thiazid)</li>
                                        <li>Bartter sy., Gitelman sy.</li>
                                    </ul>
                                </li>
                                <li><strong>Nem vese-eredet≈±:</strong>
                                    <ul class="list-disc list-inside ml-4">
                                        <li>Gyomorsav-veszt√©s (h√°ny√°s, NG szonda)</li>
                                        <li>Secretoros hasmen√©s (villosus adenoma, chlorid-veszt≈ë enteropathia)</li>
                                        <li>Cystas fibrosis (s√≥veszt≈ë)</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li><strong>Kloridrezisztens (EC volument√∂bblet, K√°liumdepl√©ci√≥!) [Vizelet Cl‚Åª > 20 mmol/l]:</strong>
                            <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                <li><strong>Magas aldosteronszint:</strong> Primer hyperaldosteronismus</li>
                                <li><strong>Alacsony aldosteronszint:</strong>
                                    <ul class="list-disc list-inside ml-4">
                                        <li>11 √©s 17 hydroxylase defectus (CAH)</li>
                                        <li>Fokozott aldost.-receptor aktivit√°s</li>
                                    </ul>
                                </li>
                                <li><strong>Secunder hyperaldosteronismus:</strong> Fokozott RAAS aktivit√°s</li>
                            </ul>
                        </li>
                    </ul></div>`);
            }

            // Respirat√≥rikus Acid√≥zis
            if (pco2Status === "Acid√≥zis") {
                causes.push(`<div><strong>Respirat√≥rikus Acid√≥zis (Hipoventill√°ci√≥):</strong>
                    <ul class="list-disc list-inside mt-1 ml-2 space-y-2 text-sm">
                        <li><strong>L√©gutak (Obstrukci√≥):</strong>
                            <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                <li>Asthma, COPD</li>
                                <li>L√©g√∫ti elz√°r√≥d√°s (Idegentest, OSAS)</li>
                            </ul>
                        </li>
                        <li><strong>T√ºd≈ë √©s Mellkas:</strong>
                            <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                <li>RDS (Respiratory Distress Syndrome)</li>
                                <li>Pneumothorax (PTX), Haemothorax (HTX)</li>
                                <li>Aspir√°ci√≥</li>
                                <li>Mellkasfali deformit√°sok (Kyphoscoliosis, Flail chest)</li>
                            </ul>
                        </li>
                        <li><strong>K√∂zponti Idegrendszer (KIR):</strong>
                            <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                <li>Gy√≥gyszerek (Opioidok, Szedat√≠vumok)</li>
                                <li>T√©rfoglal√≥ folyamatok (Tumor, V√©rz√©s)</li>
                                <li>Nyaki gerinc trauma</li>
                            </ul>
                        </li>
                        <li><strong>Ideg-, izom (Neuromuszkul√°ris):</strong>
                            <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                <li>GBS (Guillain-Barr√©), Myasthenia gravis</li>
                                <li>SMA (Spinalis Muscularis Atrophia)</li>
                                <li>Myopathi√°k, ALS, Botulizmus</li>
                            </ul>
                        </li>
                        <li><strong>Egy√©b:</strong> Malignus hyperthermia</li>
                    </ul></div>`);
            }

            // Respirat√≥rikus Alkal√≥zis
            if (pco2Status === "Alkal√≥zis") {
                causes.push(`<div><strong>Respirat√≥rikus Alkal√≥zis (Hiperventill√°ci√≥):</strong>
                    <ul class="list-disc list-inside mt-1 ml-2 space-y-2 text-sm">
                        <li><strong>K√∂zponti Idegrendszeri (KIR) okok:</strong>
                            <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                <li>Pszich√©s (stressz, szorong√°s, p√°nik)</li>
                                <li>F√°jdalom, L√°z</li>
                                <li>Agys√©r√ºl√©s, agydaganat, agyv√©rz√©s</li>
                                <li>Endog√©n anyagok (szepszis - citokinek, m√°jel√©gtelens√©g - toxinok)</li>
                                <li>Gy√≥gyszerek (szalicil√°tok, analeptikumok)</li>
                            </ul>
                        </li>
                        <li><strong>T√ºd≈ë eredet≈± (hipox√©mi√°s) okok:</strong>
                             <ul class="list-['-_'] list-inside ml-4 mt-1 space-y-1">
                                <li>Pneumonia (t√ºd≈ëgyullad√°s)</li>
                                <li>Asthma</li>
                                <li>T√ºd≈ëemb√≥lia</li>
                                <li>T√ºd≈ë√∂d√©ma (pl. sz√≠vel√©gtelens√©g miatt)</li>
                                <li>Magaslati leveg≈ë</li>
                            </ul>
                        </li>
                        <li><strong>Iatrog√©n okok:</strong> G√©pi l√©legeztet√©s (t√∫lventill√°l√°s)</li>
                        <li><strong>Egy√©b:</strong> Terhess√©g (progeszteron hat√°s)</li>
                    </ul></div>`);
            }

            // Delta Gap √©rtelmez√©s
            if (deltaData) {
                let interpretation = "";
                // Ha nincs ratio (mert HCO3 >= 24), akkor biztosan van alkal√≥zis komponens is
                if (deltaData.deltaRatio === null || deltaData.deltaRatio > 2.0) {
                    interpretation = "Kevert zavar: Magas anion r√©s≈± Metabolikus Acid√≥zis + Metabolikus Alkal√≥zis (vagy kompenz√°lt Respirat√≥rikus Acid√≥zis).";
                } else if (deltaData.deltaRatio < 0.4) {
                    interpretation = "Kevert zavar: Hiperklor√©mi√°s (norm√°l anion r√©s≈±) Acid√≥zis domin√°l.";
                } else if (deltaData.deltaRatio < 0.8) {
                    interpretation = "Kevert zavar: Magas anion r√©s≈± + Norm√°l anion r√©s≈± Metabolikus Acid√≥zis.";
                } else if (deltaData.deltaRatio <= 2.0) {
                    interpretation = "Tiszta magas anion r√©s≈± Metabolikus Acid√≥zis.";
                }
                
                causes.push(`<div><strong>Delta Gap Elemz√©s (Kevert zavarok):</strong>
                    <p class="mt-1 text-slate-700 text-sm">${interpretation}</p>
                    <p class="text-xs text-slate-500 mt-1">Korrig√°lt HCO‚ÇÉ‚Åª: ${deltaData.correctedHCO3.toFixed(1)} mEq/L (Ref: 22-26)</p></div>`);
            }

            return causes;
        }

        function getTherapeuticRecommendations(phStatus, pco2Status, hco3Status, oxygenData) {
            let recommendations = [];

            // Metabolikus Acid√≥zis
            if (hco3Status === "Acid√≥zis") {
                recommendations.push(`<div><strong>Metabolikus Acid√≥zis kezel√©se:</strong>
                    <ul class="list-disc list-inside mt-1 ml-2 space-y-1">
                        <li><strong>Alapbetegs√©g kezel√©se:</strong> Ez a legfontosabb (pl. inzulin DKA-ban, folyad√©kp√≥tl√°s szeptikus sokkban).</li>
                        <li><strong>Folyad√©kp√≥tl√°s:</strong> Krisztalloidok ad√°sa gyakran sz√ºks√©ges.</li>
                        <li><strong>Bikarbon√°t ad√°sa:</strong> Csak s√∫lyos esetben (pH < 7.1-7.2) m√©rlegelend≈ë, √≥vatosan!</li>
                    </ul></div>`);
            }

            // Metabolikus Alkal√≥zis
            if (hco3Status === "Alkal√≥zis") {
                recommendations.push(`<div><strong>Metabolikus Alkal√≥zis kezel√©se:</strong>
                    <ul class="list-disc list-inside mt-1 ml-2 space-y-1">
                        <li><strong>Folyad√©k- √©s elektrolitp√≥tl√°s:</strong> Izot√≥ni√°s s√≥oldat (NaCl) √©s K√°lium (KCl) p√≥tl√°sa kulcsfontoss√°g√∫.</li>
                        <li><strong>Kiv√°lt√≥ ok megsz√ºntet√©se:</strong> Pl. h√°ny√°s csillap√≠t√°sa, diuretikumok le√°ll√≠t√°sa/cs√∂kkent√©se.</li>
                        <li><strong>Acetazolamid:</strong> Bizonyos esetekben (pl. √∂d√©m√°s √°llapotok) m√©rlegelhet≈ë.</li>
                    </ul></div>`);
            }

            // Respirat√≥rikus Acid√≥zis
            if (pco2Status === "Acid√≥zis") {
                recommendations.push(`<div><strong>Respirat√≥rikus Acid√≥zis kezel√©se:</strong>
                    <ul class="list-disc list-inside mt-1 ml-2 space-y-1">
                        <li><strong>L√©gz√©s t√°mogat√°sa:</strong> A c√©l a ventil√°ci√≥ jav√≠t√°sa (CO‚ÇÇ kihajt√°sa).</li>
                        <li><strong>Eszk√∂z√∂k:</strong> Non-invaz√≠v l√©legeztet√©s (NIV/BiPAP) vagy intub√°ci√≥ √©s g√©pi l√©legeztet√©s s√∫lyos esetben.</li>
                        <li><strong>Gy√≥gyszeres kezel√©s:</strong> H√∂rg≈ët√°g√≠t√≥k (COPD/Asztma), l√©gz√©sdepresszi√≥ eset√©n antidotum (pl. Naloxone opi√°tokra).</li>
                    </ul></div>`);
            }

            // Respirat√≥rikus Alkal√≥zis
            if (pco2Status === "Alkal√≥zis") {
                recommendations.push(`<div><strong>Respirat√≥rikus Alkal√≥zis kezel√©se:</strong>
                    <ul class="list-disc list-inside mt-1 ml-2 space-y-1">
                        <li><strong>Ok kezel√©se:</strong> F√°jdalomcsillap√≠t√°s, l√°zcsillap√≠t√°s, szorong√°s old√°sa.</li>
                        <li><strong>L√©gz√©stechnika:</strong> Nyugodt, lass√∫ l√©gz√©sre √∂szt√∂nz√©s.</li>
                    </ul></div>`);
            }
            
            // Hipox√©mia kezel√©se
            if (oxygenData && oxygenData.needed !== "Nincs sz√ºks√©g oxig√©nre" && oxygenData.needed !== "Megfontoland√≥") {
                 recommendations.push(`<div><strong>Hipox√©mia kezel√©se:</strong>
                    <ul class="list-disc list-inside mt-1 ml-2 space-y-1">
                        <li><strong>Oxig√©nter√°pia:</strong> Orrszonda, maszk vagy magas √°raml√°s√∫ oxig√©n (HFNC) a szatur√°ci√≥ rendez√©s√©re (c√©l √°ltal√°ban >92-94%, COPD-ben 88-92%).</li>
                        <li><strong>L√©gz√©st√°mogat√°s:</strong> Ha az oxig√©n √∂nmag√°ban nem el√©g, CPAP/NIV vagy g√©pi l√©legeztet√©s lehet sz√ºks√©ges.</li>
                    </ul></div>`);
            }

            return recommendations;
        }

        function updateChart(ph, hco3) {
            const ctx = document.getElementById('astrupChart').getContext('2d');
            
            if (myChart) {
                myChart.destroy();
            }

            // Z√≥n√°k defin√≠ci√≥ja (k√∂zel√≠t≈ë hat√°rok vizualiz√°ci√≥hoz)
            const zones = [
                {
                    label: 'Norm√°l',
                    data: [{x: 7.35, y: 22}, {x: 7.45, y: 22}, {x: 7.45, y: 26}, {x: 7.35, y: 26}, {x: 7.35, y: 22}],
                    borderColor: 'rgba(34, 197, 94, 0.8)', // green
                    borderDash: []
                },
                {
                    label: 'Metabolikus Acid√≥zis',
                    data: [{x: 7.35, y: 22}, {x: 7.0, y: 10}, {x: 7.35, y: 18}],
                    borderColor: 'rgba(59, 130, 246, 0.6)', // blue
                    borderDash: [5, 5]
                },
                {
                    label: 'Metabolikus Alkal√≥zis',
                    data: [{x: 7.45, y: 26}, {x: 7.6, y: 45}, {x: 7.45, y: 30}],
                    borderColor: 'rgba(249, 115, 22, 0.6)', // orange
                    borderDash: [5, 5]
                },
                {
                    label: 'Akut Resp. Acid√≥zis',
                    data: [{x: 7.35, y: 26}, {x: 7.1, y: 30}, {x: 7.35, y: 28}],
                    borderColor: 'rgba(168, 85, 247, 0.8)', // purple
                    borderDash: []
                },
                {
                    label: 'Kr√≥nikus Resp. Acid√≥zis',
                    data: [{x: 7.35, y: 26}, {x: 7.25, y: 40}, {x: 7.35, y: 35}],
                    borderColor: 'rgba(236, 72, 153, 0.8)', // pink
                    borderDash: []
                },
                {
                    label: 'Akut Resp. Alkal√≥zis',
                    data: [{x: 7.45, y: 22}, {x: 7.65, y: 18}, {x: 7.45, y: 20}],
                    borderColor: 'rgba(234, 179, 8, 0.8)', // yellow
                    borderDash: []
                },
                {
                    label: 'Kr√≥nikus Resp. Alkal√≥zis',
                    data: [{x: 7.45, y: 22}, {x: 7.45, y: 15}, {x: 7.40, y: 18}],
                    borderColor: 'rgba(161, 98, 7, 0.8)', // brown
                    borderDash: []
                }
            ];

            const zoneDatasets = zones.map(z => ({
                label: z.label,
                data: z.data,
                showLine: true,
                fill: false,
                borderColor: z.borderColor,
                borderDash: z.borderDash,
                pointRadius: 0,
                borderWidth: 2,
                tension: 0
            }));

            myChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Beteg √°llapota',
                            data: [{x: ph, y: hco3}],
                            backgroundColor: 'rgb(239, 68, 68)', // red-500
                            borderColor: 'rgb(239, 68, 68)',
                            pointRadius: 8,
                            pointHoverRadius: 10,
                            pointBorderWidth: 2,
                            pointBackgroundColor: 'rgba(239, 68, 68, 0.8)',
                            order: 0 // Top layer
                        },
                        ...zoneDatasets.map(d => ({...d, order: 1}))
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'pH' },
                            min: 6.9,
                            max: 7.7,
                            grid: { color: '#f1f5f9' }
                        },
                        y: {
                            title: { display: true, text: 'HCO3 (mEq/L)' },
                            min: 5,
                            max: 50,
                            grid: { color: '#f1f5f9' }
                        }
                    },
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 },
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Beteg √°llapota') {
                                        return `pH: ${context.parsed.x}, HCO3: ${context.parsed.y}`;
                                    }
                                    return context.dataset.label;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>